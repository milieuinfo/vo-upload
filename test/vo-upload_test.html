<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

		<title>vo-upload test</title>

		<script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
		<script src="../node_modules/mocha/mocha.js"></script>
		<script src="../node_modules/wct-mocha/wct-mocha.js"></script>
		<script src="../node_modules/@polymer/test-fixture/test-fixture.js"></script>
		<script src="../node_modules/chai/chai.js"></script>
		<script src="../node_modules/sinon/pkg/sinon.js"></script>
    </head>
	
	<body>
		<test-fixture id="vo-upload-fixture">
			<template>
				<vo-upload url="/upload" maximum-grootte="1048576" toegelaten-mimetype="image/jpeg" toegelaten-extensie="txt" param="bestand" auto-upload maximum-aantal-bestanden="2"></vo-upload>
			</template>
		</test-fixture>

		<script type="module">
			import '../vo-upload';

			suite('vo-upload', () => {
                const should = chai.should();

				test('de dropzone wordt correct geconfigureerd', async () => {
				    let configuredElement;
				    let configuredOptions;

                    const dropzonePrototype = Dropzone.prototype;
                    window.Dropzone = function(element, options) {
                        configuredElement = element;
                        configuredOptions = options;
				        return {}
                    };
				    window.Dropzone.prototype = dropzonePrototype;

                    const element = fixture("vo-upload-fixture");
                    await element.updateComplete;

                    should.exist(configuredElement);
                    assert.equal(configuredOptions.url, '/upload');
                    assert.equal(configuredOptions.maxFilesize, 1);
                    assert.equal(configuredOptions.acceptedFiles, 'txt,image/jpeg');
                    assert.equal(configuredOptions.paramName, 'bestand');
                    assert.equal(configuredOptions.maxFiles, 2);
                    assert.equal(configuredOptions.autoProcessQueue, true);
                    assert.equal(configuredOptions.addRemoveLinks, true);
                });

                test('het "vo-upload-bestand-toegevoegd" event wordt afgevuurd wanneer een bestand werd toegevoegd', (done) => {
                    valideerEvent(
                        'addedfile',
                        'vo-upload-bestand-toegevoegd',
                        (dropzoneEventFun) => {
                            dropzoneEventFun(dropzoneBestand());
                        },
                        (event) => {
                            assert.deepEqual(bestand(), event.detail.bestand);
                            done();
                        }
                    );
                });

                test('het "vo-upload-bestand-verwijderd" event wordt afgevuurd wanneer een bestand werd verwijderd', (done) => {
                    valideerEvent(
                        'removedfile',
                        'vo-upload-bestand-verwijderd',
                        (dropzoneEventFun) => {
                            dropzoneEventFun(dropzoneBestand());
                        },
                        (event) => {
                            assert.deepEqual(bestand(), event.detail.bestand);
                            done();
                        }
                    );
                });

                test('het "vo-upload-versturen" event wordt afgevuurd vlak voor het verzenden van het bestand', (done) => {
                    valideerEvent(
                        'sending',
						'vo-upload-versturen',
                        (dropzoneEventFun) => {
                            dropzoneEventFun(dropzoneBestand());
                        },
						(event) => {
                            assert.deepEqual(bestand(), event.detail.bestand);
                            done();
						}
					);
                });

                test('het "vo-upload-succes" event wordt afgevuurd wanneer het uploaden succesvol voltooid is', (done) => {
                    const response = { foo: 'bar' };
                    valideerEvent(
                        'success',
                        'vo-upload-succes',
						(dropzoneEventFun) => {
                            dropzoneEventFun(dropzoneBestand(), response);
						},
                        (event) => {
                            assert.deepEqual(bestand(), event.detail.bestand);
                            assert.deepEqual(response, event.detail.response);
                            done();
                        }
                    );
                });

                test('het "vo-upload-fout" event wordt afgevuurd wanneer het uploaden niet kon geupload worden', (done) => {
                    const fout = { foo: 'bar' };
                    valideerEvent(
                        'error',
                        'vo-upload-fout',
                        (dropzoneEventFun) => {
                            dropzoneEventFun(dropzoneBestand(), fout);
                        },
                        (event) => {
                            assert.deepEqual(bestand(), event.detail.bestand);
                            assert.deepEqual(fout, event.detail.fout);
                            done();
                        }
                    );
                });

				test('er kan een bestand manueel geupload worden via de upload functie', async () => {
                    const dropzonePrototype = Dropzone.prototype;
					window.Dropzone = function(element, options) {
				        return {
							processQueue: () => {}
						}
                    };
				    window.Dropzone.prototype = dropzonePrototype;

					const element = fixture("vo-upload-fixture");
					await element.updateComplete;
					sinon.spy(element._dropzone, 'processQueue');
					element.upload();
					assert(element._dropzone.processQueue.called);
				});

                test('wanneer er meer bestanden worden toegevoegd dan toegelaten, worden de overtollige oude bestanden uit de queue verwijderd', (done) => {
                    let dropzoneEventFun;
                    const dropzonePrototype = Dropzone.prototype;
                    const removeFileSpy = sinon.spy();
                    const bestand1 = { name: 'file1' };
                    const bestand2 = { name: 'file2' };
                    const bestand3 = { name: 'file3' };
                    const bestand4 = { name: 'file4' };
                    window.Dropzone = function(element, options) {
                        this.on = function(eventName, fn) {
                            if(eventName === 'addedfile') {
                                dropzoneEventFun = fn;
                            }
                        };
                        options.init.call(this);
                        return {
                            files: [ bestand1, bestand2, bestand3, bestand4 ],
                            removeFile: removeFileSpy
						}
                    };
                    window.Dropzone.prototype = dropzonePrototype;

                    const element = fixture("vo-upload-fixture");
                    element.updateComplete.then(() => {
                        dropzoneEventFun(dropzoneBestand());
                        assert(removeFileSpy.calledWith(bestand1));
                        assert(removeFileSpy.calledWith(bestand2));
                        assert(removeFileSpy.neverCalledWith(bestand3));
                        assert(removeFileSpy.neverCalledWith(bestand4));
                        done();
                    });
                });

                function valideerEvent(dropzoneEvent, voUploadEvent, dropzoneEventFunCaller, assertFun) {
                    let dropzoneEventFun;

                    const dropzonePrototype = Dropzone.prototype;
                    window.Dropzone = function(element, options) {
                        this.on = function(eventName, fn) {
                            if(eventName === dropzoneEvent) {
                                dropzoneEventFun = fn;
                            }
                        };
                        options.init.call(this);
                        return {
                            files: [ ]
						}
                    };
                    window.Dropzone.prototype = dropzonePrototype;

                    const element = fixture("vo-upload-fixture");
                    element.addEventListener(voUploadEvent, (event) => { assertFun(event); });
                    element.updateComplete.then(() => { dropzoneEventFunCaller(dropzoneEventFun); });
				}

                function bestand() {
                    return {
                        id: 'a12ea7e1-dea1-4908-916d-c18d5db98d25',
                        naam: 'myfilename.txt',
                        grootte: 123,
                        type: 'image/jpeg',
                        laatstGewijzigd: 456
                    }
                }

                function dropzoneBestand() {
                    return {
                        name: 'myfilename.txt',
                        size: 123,
                        type: 'image/jpeg',
                        lastModified: 456,
						upload: {
                            uuid: 'a12ea7e1-dea1-4908-916d-c18d5db98d25'
						}
                    }
				}
			});
		</script>
	</body>
</html>